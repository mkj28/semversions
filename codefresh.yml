version: '1.0'
steps:
  build:
    title: Build Docker Image
    type: build
    image_name: mkj28/semversions
    working_directory: ./
    dockerfile: Dockerfile

  semver:
    image: ${{build}}
    title: Setting Semversions
    working_directory: ${{main_clone}}
    commands:
      - echo ${SSH_KEY} | base64 -d > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
      - pwd
      - git status
      - git rev-parse HEAD
      - git tag v$(date "+%Y").$(date "+%m%d").$(printf %04d $(git rev-list HEAD --count --date=local --after "yesterday"))
      - git push --tags
    when:
      branch:
        only:
          - master
